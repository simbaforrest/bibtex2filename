function wordwrap(str,int_width,str_break,cut){var m=int_width,b=str_break,c=cut;var i,j,l,s,r;if(m<1){return str}for(i=-1,l=(r=str.split("\n")).length;++i<l;r[i]+=s){for(s=r[i],r[i]="";s.length>m;r[i]+=s.slice(0,j)+((s=s.slice(j)).length?b:"")){j=c==2||(j=s.slice(0,m+1).match(/\S*(\s)?$/))[1]?m:j.input.length-j[0].length||c==1&&m||j.input.length+(j=s.slice(m).match(/^\S*/)).input.length}}return r.join("\n")}function is_string(mixed_var){return(typeof(mixed_var)=="string")}function array_unique(array){var p,i,j,tmp_arr=array;for(i=tmp_arr.length;i;){for(p=--i;p>0;){if(tmp_arr[i]===tmp_arr[--p]){for(j=p;--p&&tmp_arr[i]===tmp_arr[p];){}i-=tmp_arr.splice(p+1,j-p).length}}}return tmp_arr}function is_array(mixed_var){return(mixed_var instanceof Array)}function BibTex(options){if(typeof options=="undefined"){options={}}this.data;this.content;this._delimiters;this.warnings;this._options;this.rtfstring;this.htmlstring;this.allowedEntryTypes;this.authorstring;this._delimiters={'"':'"',"{":"}"};this.data=[];this.content="";this.warnings=[];this._options={stripDelimiter:true,validate:true,unwrap:false,wordWrapWidth:false,wordWrapBreak:"\n",wordWrapCut:0,removeCurlyBraces:false,extractAuthors:true};for(option in options){test=this.setOption(option,options[option]);if(this.isError(test)){}}this.rtfstring='AUTHORS, "{\b TITLE}", {i JOURNAL}, YEAR';this.htmlstring='AUTHORS, "<strong>TITLE</strong>", <em>JOURNAL</em>, YEAR<br />';this.allowedEntryTypes=["article","book","booklet","confernce","inbook","incollection","inproceedings","manual","masterthesis","misc","phdthesis","proceedings","techreport","unpublished"];this.authorstring="VON LAST, JR, FIRST"}BibTex.prototype={setOption:function(option,value){ret=true;if("undefined"!=this._options[option]){this._options[option]=value}else{ret={isError:1,msg:("Unknown option "+option)}}return ret},parse:function(){this.warnings=[];this.data=[];var valid=true;var open=0;var entry=false;var charv="";var lastchar="";var buffer="";for(var i=0;i<this.content.length;i++){charv=this.content[i];if((0!=open)&&("@"==charv)){if(!this._checkAt(buffer)){this._generateWarning("WARNING_MISSING_END_BRACE","",buffer);charv="}";i--}}if((0==open)&&("@"==charv)){entry=true}else{if(entry&&("{"==charv)&&("\\"!=lastchar)){open++}else{if(entry&&("}"==charv)&&("\\"!=lastchar)){open--;if(open<0){valid=false}if(0==open){entry=false;var entrydata=this._parseEntry(buffer);if(!entrydata){}else{this.data[this.data.length]=entrydata}buffer=""}}}}if(entry){buffer+=charv}lastchar=charv}if(1==open){entrydata=this._parseEntry(buffer);if(!entrydata){valid=false}else{this.data[this.data.length]=entrydata;buffer="";open=0}}if(0!=open){valid=false}if(this._options.validate){var cites=[];for(var i=0;i<this.data.length;i++){cites[cites.length]=this.data[i]["cite"]}unique=array_unique(cites);if(cites.length!=unique.length){var notuniques=[];for(var i=0;i<cites.length;i++){if(""==unique[i]){notuniques[notuniques.length]=cites[i]}}this._generateWarning("WARNING_MULTIPLE_ENTRIES",notuniques.join(","))}}if(valid){this.content="";return true}else{return{isError:1,msg:("Unbalanced parenthesis")}}},_parseEntry:function(entry){var entrycopy="";if(this._options.validate){entrycopy=entry}var ret={};if("@string"==entry.substr(0,7).toLowerCase()){if(this._options.validate){this._generateWarning("STRING_ENTRY_NOT_YET_SUPPORTED","",entry+"}")}}else{if("@preamble"==entry.substr(0,9).toLowerCase()){if(this._options.validate){this._generateWarning("PREAMBLE_ENTRY_NOT_YET_SUPPORTED","",entry+"}")}}else{var firstPos=entry.indexOf("{");var entryType=entry.substring(1,firstPos);entry=entry.substring(firstPos+1,entry.length);ret.entryType=entryType.trim().toLowerCase();if(this._options.validate){if(!this._checkAllowedEntryType(ret.entryType)){this._generateWarning("WARNING_NOT_ALLOWED_ENTRY_TYPE",ret.entryType,entry+"}")}}while(entry.lastIndexOf("=")!==-1){position=entry.lastIndexOf("=");proceed=true;if(entry[position-1]=="\\"){proceed=false}if(proceed){proceed=this._checkEqualSign(entry,position)}while(!proceed){substring=entry.substr(0,position);position=substring.lastIndexOf("=");proceed=true;if(entry[position-1]=="\\"){proceed=false}if(proceed){proceed=this._checkEqualSign(entry,position)}}value=entry.substr(position+1).trim();entry=entry.substr(0,position);if(","==value[value.length-1]){value=value.slice(0,-1)}if(this._options.validate){this._validateValue(value,entrycopy)}if(this._options.unwrap){value=this._unwrap(value)}if(this._options.stripDelimiter){value=this._stripDelimiter(value)}if(this._options.removeCurlyBraces){value=this._removeCurlyBraces(value)}position=entry.lastIndexOf(",");field=entry.substr(position+1).trim().toLowerCase();ret[field]=value;entry=entry.substr(0,position)}ret.cite=entry.trim();if(ret.cite.length<=0){console.log("BibTex warn: no cite field for this entry!")}if("undefined"!==typeof ret.author&&this._options.extractAuthors){ret.author=this._extractAuthors(ret.author)}}}return ret},_checkEqualSign:function(entry,position){var ret=true;var length=entry.length;var open=0;for(var i=length-1;i>=position;i--){precedingchar=entry[i-1];charv=entry[i];if(("{"==charv)&&("\\"!=precedingchar)){open++}if(("}"==charv)&&("\\"!=precedingchar)){open--}}if(0!=open){ret=false}if(ret){entrycopy=entry.trim();lastchar=entrycopy.slice(-1);if(","==lastchar){lastchar=entrycopy.slice(-2,-1)}if('"'==lastchar){ret=false;found=0;for(var i=length;i>=position;i--){precedingchar=entry[i-1];charv=entry[i];if(('"'==charv)&&("\\"!=precedingchar)){found++}if(2==found){ret=true;break}}}}return ret},_checkAllowedEntryType:function(entry){return this.allowedEntryTypes.indexOf(entry)>=0},_checkAt:function(entry){var ret=false;var opening=Object.keys(this._delimiters);var closing=[];for(key in this._delimiters){closing.push(this._delimiters[key])}if(entry.lastIndexOf("=")>=0){position=entry.lastIndexOf("=");proceed=true;if(entry[position-1]=="\\"){proceed=false}while(!proceed){substring=entry.substr(0,position);position=substring.lastIndexOf("=");proceed=true;if(entry[position-1]=="\\"){proceed=false}}value=entry.slice(position+1).trim();open=0;charv="";lastchar="";for(var i=0;i<value.length;i++){charv=this.content[i];if(opening.indexOf(charv)>=0&&("\\"!=lastchar)){open++}else{if(closing.indexOf(charv)&&("\\"!=lastchar)){open--}}lastchar=charv}if(open>0){ret=true}}return ret},_stripDelimiter:function(entry){var beginningdels=Object.keys(this._delimiters);var firstchar=entry[0];var lastchar=entry.slice(-1);while(beginningdels.indexOf(firstchar)>=0){if(lastchar==this._delimiters[firstchar]){entry=entry.slice(1,-1)}else{break}entry=entry.trim();firstchar=entry[0];lastchar=entry[entry.length-1]}return entry},_unwrap:function(entry){entry=entry.replace(/\s+/g," ");return entry.trim()},_wordwrap:function(entry){if((""!=entry)&&(is_string(entry))){entry=wordwrap(entry,this._options.wordWrapWidth,this._options.wordWrapBreak,this._options.wordWrapCut)}return entry},_extractAuthors:function(entry){entry=this._unwrap(entry);var authorarray=[];authorarray=entry.split(/\s+and\s+/);for(var i=0;i<authorarray.length;i++){var author=authorarray[i].trim();var first="";var von="";var last="";var jr="";if(author.indexOf(",")<0){var tmparray=[];tmparray=author.split(/[\s\~]+/);var size=tmparray.length;if(1==size){last=tmparray[0]}else{if(2==size){first=tmparray[0];last=tmparray[1]}else{var invon=false;var inlast=false;for(var j=0;j<(size-1);j++){if(inlast){last+=" "+tmparray[j]}else{if(invon){casev=this._determineCase(tmparray[j]);if(this.isError(casev)){}else{if((0==casev)||(-1==casev)){islast=true;for(var k=(j+1);k<(size-1);k++){futurecase=this._determineCase(tmparray[k]);if(this.isError(casev)){}else{if(0==futurecase){islast=false}}}if(islast){inlast=true;if(-1==casev){last+=" "+tmparray[j]}else{von+=" "+tmparray[j]}}else{von+=" "+tmparray[j]}}else{von+=" "+tmparray[j]}}}else{var casev=this._determineCase(tmparray[j]);if(this.isError(casev)){}else{if(0==casev){invon=true;von+=" "+tmparray[j]}else{first+=" "+tmparray[j]}}}}}last+=" "+tmparray[size-1]}}}else{var tmparray=[];tmparray=author.split(",");var vonlastarray=[];vonlastarray=tmparray[0].split(/\s+/);size=vonlastarray.length;if(1==size){last=vonlastarray[0]}else{inlast=false;for(var j=0;j<(size-1);j++){if(inlast){last+=" "+vonlastarray[j]}else{if(0!=(this._determineCase(vonlastarray[j]))){islast=true;for(var k=(j+1);k<(size-1);k++){this._determineCase(vonlastarray[k]);casev=this._determineCase(vonlastarray[k]);if(this.isError(casev)){}else{if(0==casev){islast=false}}}if(islast){inlast=true;last+=" "+vonlastarray[j]}else{von+=" "+vonlastarray[j]}}else{von+=" "+vonlastarray[j]}}}last+=" "+vonlastarray[size-1]}if(3==tmparray.length){jr=tmparray[1]}first=""+tmparray.slice(-1)[0]}authorarray[i]={first:first.trim(),von:von.trim(),last:last.trim(),jr:jr.trim()}}return authorarray},_determineCase:function(word){var ret=-1;var trimmedword=word.trim();if(is_string(word)&&(trimmedword.length>0)){var i=0;var found=false;var openbrace=0;while(!found&&(i<=word.length)){var letter=trimmedword[i];var ordv=letter.charCodeAt(0);if(ordv==123){openbrace++}if(ordv==125){openbrace--}if((ordv>=65)&&(ordv<=90)&&(0==openbrace)){ret=1;found=true}else{if((ordv>=97)&&(ordv<=122)&&(0==openbrace)){ret=0;found=true}else{i++}}}}else{ret={isError:1,msg:("Could not determine case on word: "+word)}}return ret},isError:function(obj){return(typeof(obj)=="Object"&&obj.isError==1)},_validateValue:function(entry,wholeentry){if(entry.match(/^{.*@.*}/)){this._generateWarning("WARNING_AT_IN_BRACES",entry,wholeentry)}if(entry.match(/^\".*\\".*\"/)){this._generateWarning("WARNING_ESCAPED_DOUBLE_QUOTE_INSIDE_DOUBLE_QUOTES",entry,wholeentry)}var open=0;var lastchar="";var charv="";for(var i=0;i<entry.length;i++){charv=entry[i];if(("{"==charv)&&("\\"!=lastchar)){open++}if(("}"==charv)&&("\\"!=lastchar)){open--}lastchar=charv}if(0!=open){this._generateWarning("WARNING_UNBALANCED_AMOUNT_OF_BRACES",entry,wholeentry)}},_removeCurlyBraces:function(value){var beginningdels=Object.keys(this._delimiters);var firstchar=value[0];var lastchar=value.slice(-1);var begin="";var end="";while(beginningdels.indexOf(firstchar)){if(lastchar==this._delimiters[firstchar]){begin+=firstchar;end+=lastchar;value=value.slice(1,-1)}else{break}firstchar=value[0];lastchar=value.slice(-1)}var pattern="/([^\\\\]){(+*?[^\\\\])}/";var replacement="12";value=value.replace(/([^\\\\])\{(.*?[^\\\\])\}/,replacement);value=begin+value+end;return value},_generateWarning:function(type,entry,wholeentry){if(typeof wholeentry=="undefined"){wholeentry=""}var warning={};warning.warning=type;warning.entry=entry;warning.wholeentry=wholeentry;this.warnings[this.warnings.length]=warning},clearWarnings:function(){this.warnings=[]},hasWarning:function(){if(this.warnings.length>0){return true}else{return false}},_formatAuthor:function(array){if("undefined"==typeof array.von){array.von=""}else{array.von=array.von.trim()}if("undefined"==typeof array.last){array.last=""}else{array.last=array.last.trim()}if("undefined"==typeof array.jr){array.jr=""}else{array.jr=array.jr.trim()}if("undefined"==typeof array.first){array.first=""}else{array.first=array.first.trim()}ret=this.authorstring;ret=ret.replace(/VON/g,array.von);ret=ret.replace(/LAST/g,array.last);ret=ret.replace(/JR/g,array.jr);ret=ret.replace(/FIRST/g,array.first);return ret.trim()},bibTex:function(){var bibtex="";for(var i=0;i<this.data.length;i++){var entry=this.data[i];bibtex+="@"+entry.entryType.toLowerCase()+" { "+entry.cite+",\n";for(key in entry){var val=entry[key];if(this._options.wordWrapWidth>0){val=this._wordWrap(val)}if(key!="cite"||key!="entryType"||key!="author"){bibtex+="\t"+key+" = {"+val+"},\n"}}if("undefined"!==typeof entry.author){if(this._options.extractAuthors){tmparray=[];for(j in entry.author){var authorentry=entry.author[j];tmparray[tmparray.length]=this._formatAuthor(authorentry)}author=tmparray.join(" and ")}else{author=entry.author}}else{author=""}bibtex+="\tauthor = {"+author+"}\n";bibtex+="}\n\n"}return bibtex},addEntry:function(newentry){this.data[this.data.length]=newentry},getStatistic:function(){var ret=[];for(var i=0;i<this.data.length;i++){var entry=this.data[i];if("undefined"!=ret[entry.entryType]){ret[entry.entryType]++}else{ret[entry.entryType]=1}}return ret}};